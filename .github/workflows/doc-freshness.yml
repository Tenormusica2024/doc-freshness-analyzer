name: Document Freshness Check

on:
  workflow_dispatch:
    inputs:
      target_repo:
        description: 'Repository to analyze (owner/repo or local path)'
        required: true
        type: string
      branch:
        description: 'Branch to analyze'
        required: false
        default: 'main'
        type: string

  pull_request:
    paths:
      - '**.md'
      - 'package.json'
      - 'requirements.txt'
      - '.env.example'

jobs:
  analyze:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup PowerShell
        shell: bash
        run: |
          if ! command -v pwsh &> /dev/null; then
            sudo apt-get update
            sudo apt-get install -y powershell
          fi

      - name: Run Document Freshness Analysis
        id: analyze
        shell: pwsh
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TARGET_REPO: ${{ github.event.inputs.target_repo || github.repository }}
          TARGET_BRANCH: ${{ github.event.inputs.branch || github.head_ref || 'main' }}
        run: |
          $ErrorActionPreference = 'Continue'
          
          $result = & ./scripts/run-analysis.ps1 -Target $env:TARGET_REPO -Branch $env:TARGET_BRANCH -JsonOnly
          
          $result | Out-File -FilePath analysis-result.json -Encoding UTF8
          
          $json = $result | ConvertFrom-Json
          if ($json.documents.summary) {
            echo "docs_count=$($json.documents.summary.totalFiles)" >> $env:GITHUB_OUTPUT
            echo "issues_found=true" >> $env:GITHUB_OUTPUT
          }

      - name: Upload Analysis Result
        uses: actions/upload-artifact@v4
        with:
          name: doc-freshness-report
          path: analysis-result.json
          retention-days: 30

      - name: Comment on PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            
            let report = '';
            try {
              const result = fs.readFileSync('analysis-result.json', 'utf8');
              const json = JSON.parse(result);
              
              const docsCount = json.documents?.summary?.totalFiles || 0;
              const sourceCount = json.sourceCode?.summary?.totalSourceFiles || 0;
              
              report = `## Document Freshness Analysis
              
              | Metric | Value |
              |--------|-------|
              | Documents Analyzed | ${docsCount} |
              | Source Files | ${sourceCount} |
              
              Full analysis results are available in the workflow artifacts.
              
              > Generated by doc-freshness-analyzer`;
            } catch (e) {
              report = `## Document Freshness Analysis
              
              Analysis completed. Check workflow artifacts for detailed results.
              
              > Generated by doc-freshness-analyzer`;
            }
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: report
            });

  self-check:
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup PowerShell
        shell: bash
        run: |
          if ! command -v pwsh &> /dev/null; then
            sudo apt-get update
            sudo apt-get install -y powershell
          fi

      - name: Self-check (analyze own docs)
        shell: pwsh
        run: |
          $result = & ./scripts/run-analysis.ps1 -Target . -JsonOnly
          $result | Out-File -FilePath self-check-result.json -Encoding UTF8
          
          Write-Host "Self-check completed"

      - name: Upload Self-check Result
        uses: actions/upload-artifact@v4
        with:
          name: self-check-report
          path: self-check-result.json
          retention-days: 7
